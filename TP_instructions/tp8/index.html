
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>TP8 - Monitoring de mod√®les</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="tp8"
                  title="TP8 - Monitoring de mod√®les"
                  environment="web"
                  feedback-link="https://gitlab.com/octo-technology/octo-bda/cercle-formation/dsin2/-/issues/new">
    
      <google-codelab-step label="Overview" duration="1">
        <h2 is-upgraded>A l&#39;issue de cette section, vous aurez d√©couvert</h2>
<ul>
<li>üìà Comment fonctionne Grafana, un outil de dashboarding,</li>
<li>üóÑ Comment brancher une datasource PostgreSQL dans Grafana,</li>
<li>üìà Comment construire un dashboard de monitoring dans Grafana,</li>
<li>‚öôÔ∏è Comment alimenter une base de donn√©es PostgreSQL avec des donn√©es de pr√©diction produites dans un pipeline Airflow</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Un mot sur PostgreSQL" duration="0">
        <p>PostgreSQL est un SGBD (Syst√®me de Gestion de Bases de Donn√©es) relationnel. C&#39;est un syst√®me robuste que nous utilisons souvent en production dans nos missions √† OCTO Technology.</p>
<p>Un <code>SGBD</code> PostgreSQL commun √† tous les form√©s est d√©ploy√© dans l&#39;environnement de d√©veloppement Jupyterhub, il est configur√© comme suit:</p>
<ul>
<li>c&#39;est un service dockeris√© accessible sur le port <code>5432</code>,</li>
<li>il est accessible avec le login: <code>postgres</code> et le mot de passe <code>postgres</code>,</li>
<li>il contient 1 <code>base de donnees</code> nomm√©e <code>postgres</code>,</li>
<li>au d√©marrage, cette base de donn√©es ne contient aucune <code>table</code>. Mais cette cr√©ation de table sera g√©r√©e par le DAG de pr√©diction Airflow.</li>
</ul>
<p>V√©rifiez cela en ex√©cutant ligne par ligne ce qui suit dans un interpr√©teur Python:</p>
<pre><code>conn = psycopg2.connect(&#34;host=postgres dbname=postgres user=postgres password=postgres&#34;)

cur = conn.cursor()

# Afficher les tables dans la base de donn√©es
cur.execute(&#34;&#34;&#34;SELECT table_name FROM information_schema.tables WHERE table_schema = &#39;public&#39;&#34;&#34;&#34;)
for table in cur.fetchall():
    print(table)

# Afficher le contenu de la table monitoring
cur.execute(&#39;SELECT * FROM monitoring;&#39;)
conn.commit()
print(cur.featchall())

conn.close()
</code></pre>
<p>Plus tard, r√©-ex√©cutez ces lignes apr√®s avoir ex√©cut√© au moins 1 fois le DAG de pr√©diction pour consulter les pr√©dictions sauvegard√©es.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Un mot sur Grafana" duration="0">
        <p>Grafana est un outil open-source permettant de construire des dashboards. Il est souvent utilis√© par les ing√©nieurs op√©rationnels (ops) pour des t√¢ches de monitoring de syst√®mes (RAM, CPU, consommation disque de serveurs, ...).</p>
<p>Une instance Grafana commune √† tous les form√©s est d√©ploy√©e dans l&#39;environnement de d√©veloppement Jupyterhub, il est configur√© comme suit:</p>
<ul>
<li>c&#39;est un service dockeris√© accessible sur le port <code>3000</code>,</li>
<li>On peut s&#39;y connecter avec le login <code>admin</code> et le mot de passe <code>admin</code>.</li>
</ul>
<p>üèπ V√©rifiez que le service grafana est disponible dans votre terminal avec <code>wget --server-response grafana:3000</code>.</p>
<p>Les formateurs vont d√©sormais configurer grafana afin d&#39;y connecter la base de donn√©es PostgreSQL en tant que <code>datasource</code>.</p>
<p>Dans Grafana,</p>
<ul>
<li>Ajoutez une datasource,</li>
<li>Choisissez une datasource <code>PostgreSQL</code>,</li>
<li>Configurez la data source:</li>
</ul>
<table>
<tr></tr>
<tr><td colspan="1" rowspan="1"><p>Name</p>
</td><td colspan="1" rowspan="1"><p>PostgreSQL</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Host</p>
</td><td colspan="1" rowspan="1"><p><a href="postgres:5432" target="_blank">postgres:5432</a></p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Database</p>
</td><td colspan="1" rowspan="1"><p>postgres</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>User</p>
</td><td colspan="1" rowspan="1"><p>postgres</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>Password</p>
</td><td colspan="1" rowspan="1"><p>postgres</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>SSL Mode</p>
</td><td colspan="1" rowspan="1"><p>disable</p>
</td></tr>
<tr><td colspan="1" rowspan="1"><p>PostgreSQL version</p>
</td><td colspan="1" rowspan="1"><p>9.6</p>
</td></tr>
</table>
<p class="image-container"><img alt="postgres-datasource" src="img/800ebf705b9be4f9.png"></p>
<p>üèÅ Vous pouvez d√©sormais cr√©er un dashboard branch√© sur cette source de donn√©es !</p>


      </google-codelab-step>
    
      <google-codelab-step label="Monitorer les pr√©dictions d&#39;un mod√®le" duration="0">
        <p>Dans le dag <code>dags/predict.py</code>:</p>
<ul>
<li>Ajoutez une t√¢che finale permettant de monitorer les pr√©dictions. Cette t√¢che s&#39;appuiera sur la fonction <code>monitor_with_io()</code> du module Python <code>formation_indus_avancee</code>.</li>
<li>Modifiez la table de destination sp√©cifi√©e dans la fonction <code>monitor_with_io()</code> avec un nom unique.</li>
<li>Dans la console Airflow, activez le dag de pr√©diction.</li>
<li>Une fois la t√¢che <code>monitor</code> du dag de pr√©diction termin√©e avec succ√®s, rendez-vous dans Grafana pour construire votre dashboard !  <ul>
<li>Survolez le bouton ‚ûï dans la barre lat√©rale pour cr√©er un dashboard,</li>
<li>Pensez √† le renommer pour ne pas le confondre avec celui de quelqu&#39;un d&#39;autre !</li>
<li>Ajoutez un panel et faites le pointer vers la data source &#34;PostgreSQL&#34; configur√©e auparavant.</li>
</ul>
</li>
</ul>
<p class="image-container"><img alt="panel" src="img/cf3f54359deb9129.png"></p>
<p>üèÅ Au bout d&#39;une quinzaine de minutes, le DAG de prediction aura suffisamment aliment√© la base de donn√©es pour pouvoir observer des choses int√©ressantes dans Grafana !</p>
<p class="image-container"><img alt="dashboard" src="img/1a9b4bcb38351d6b.png"></p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
